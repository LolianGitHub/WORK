<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PyGoDoc</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../static/richtext/src/richtext.min.css">
    <link rel="stylesheet" href="../static/edit.css">
</head>

<body>
<h1>PyGoDoc</h1>
<textarea id="text_area"></textarea>
<p class="message">log</p>
</body>

<script src="../static/jquery-3.3.1.min.js"></script>
<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>-->
<script src="../static/richtext/src/jquery.richtext.js"></script>
<script>
String.prototype.hashCode = function() {
    var hash = 0, i, chr;
    if (this.length === 0) return hash;
    for (i = 0; i < this.length; i++) {
        chr   = this.charCodeAt(i);
        hash  = ((hash << 5) - hash) + chr;
        hash |= 0; // Convert to 32bit integer
    }
    return hash;
};

function upload_text(text) {
    $.ajax({
        url: '/update',
        type: 'POST',
        data: {"text": text}
    })
}

function fetch_text(handler) {
    $.ajax({
        url: '/fetch',
        type: 'GET',
    }).done(function(msg) {
        handler(msg);
    });
}


$(document).ready(function() {
    $('#text_area').richText();

    let p = $('.message');
    let ta = $('.richText-editor');
    let last_hash = ta.html().hashCode();

    function text_update_handler(text) {
        ta.html(text);
        p.text('fetched');
    }

    setInterval(function() {
        let new_text = ta.html();
        let new_hash = new_text.hashCode();
        if(new_hash != last_hash) {
            p.text(new_hash);
            upload_text(new_text);
            last_hash = new_hash;
        } else {
            fetch_text(text_update_handler);
        }
    }, 1000);



});

</script>

</html>